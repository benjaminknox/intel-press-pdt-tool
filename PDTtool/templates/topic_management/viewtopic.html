{% extends "base.html" %}
{% load staticfiles %}
{% block content %}
	{% if Supervisor and not topic.topic_object.supervisor_released %}
	<!-- Output the release button if the user is a supervisor-->
	<form method="POST" action="{{ request.get_full_path }}">
		{% csrf_token %}
		<input type="hidden" name="released_topicid" value="{{ request.GET.publicid }}" />
		<input type="submit" value="Release This Topic" id="release_button" class="btn btn-success light-button btn-mini" />
	</form>
	<!-- End output of the release button -->
	{% endif %}

	{% if Supervisor or user_is_owner %}
	<!-- Output the delete button if the user owns the document -->
	<form method="POST" action="{{ request.get_full_path }}">
		{% csrf_token %}
		<input type="hidden" name="deleted_topicid" value="{{ request.GET.publicid }}" />
		<input type="submit" value="Delete This Topic" id="delete_button" class="btn light-button btn-mini" />
	</form>
	<!-- End output of the delete button -->
	<div class=""></div>
	{% endif %}

	{% if user_is_owner %}

	{{topic.add_document}}

	{% for document in documents %}
		{{ document.update_document_form }}
		{{ document.deleted_document_form }}
	{% endfor %}

	{% endif %}

	<h5>
	{{topic.topic_object.name}}&nbsp;&nbsp;<small>{{topic.topic_object.topic_slug}}</small>
	{% if topic.topic_object.meeting %}
		&nbsp;&nbsp;&nbsp;<a href="/viewmeetings/?month={{ topic.topic_object.meeting.startdate.month }}&year={{ topic.topic_object.meeting.startdate.year }}#{{ topic.topic_object.meeting.publicid }}">View Meeting Schedule</a>
	{% endif %}
	{% if  topic.topic_object.supervisor_released %}
		<span class="label label-success margin-left-10">Approved</span>
	{% endif %}
	</h5>
	<div>
		<table class="table table-striped">
			<tr>
				<th class="document_item add_document" publicid="{{ topic.topic_object.publicid }}">Document
					{% if user_is_owner %}
					<i class="icon-plus-sign document_button" title="Add a document." publicid="{{ topic.topic_object.publicid }}"></i>
					{% endif %}
				</th>
				<td style="width: 15px;"></td>
				<td style="width: 15px;"></td>
				<th># Comments</th>
				<th></th>
			</tr>
		{% for document in documents %}

			<tr class="document_item change_document" publicid="{{ document.document_object.publicid }}">
				<td>
					<a href="/download/{{ topic.topic_object.publicid}}/{{ document.document_object.fileName}}" class="download_link" title="{{ document.document_object.name }}">{{ document.document_object.name | truncatechars:50  }}</a>
				</td>
				<td>
					{% if user_is_owner %}
					<i class="icon-upload document_button" title="Revise this document." publicid="{{ document.document_object.publicid }}"></i>
					{% endif %}					
				</td>
				<td>
					{% if user_is_owner %}
					<i class="icon-trash document_button" title="Delete this document." publicid="{{ document.document_object.publicid }}"></i>
					{% endif %}
				</td>
				</td>
				<td>{{ document.document_object.comments.count }}</td>
				<td>

					{% if document.document_object.comments.count > 0 %}
						<a href="javascript:$('#document_feedback_{{ document.document_object.publicid }}').toggle();" class="btn btn-success btn-mini pull-right lighter-button">View Feedback</a>
					{% else %}
						<a href="javascript:$('#document_feedback_{{ document.document_object.publicid }}').toggle();" onclick="$('#document_comment_form_{{ document.document_object.publicid }}').toggle();" class="btn btn-primary btn-mini pull-right lighter-button">Add Feedback</a>
					{% endif %}
				</td>
			<tr>
			<tr style="display: none;" class="document_feedback" id="document_feedback_{{ document.document_object.publicid }}">
				<td colspan="5">

					{% if document.document_object.comments.count > 0 %}
						<a href="javascript:$('#document_comment_form_{{ document.document_object.publicid }}').toggle();" class="btn btn-primary btn-mini lighter-button">Add Feedback</a>
					{% endif %}

					{{ document.comment_form|safe }}
					{% for comment in document.comments %}
						{{ comment.html | safe }}
					{% endfor %}

				</td>
			</tr>

		{% endfor %}
		</table>
		{% if Supervisor or user_is_owner %}
		{% if not topic.topic_object.supervisor_released %}
		<div id="release_interface">
			<form method="POST" action="{{ request.get_full_path }}" class="form-inline">
				{% csrf_token %}
				<input type="hidden" name="topic_ready_for_review_id" value="{{ topic.topic_object.publicid }}"  />
			{% if not topic.topic_object.readyforreview %}
				Presentation Length: <input type="text" style="width: 30px" name="topic_presentationlength" value="15" /> minutes
				<input type="submit" class="btn btn-primary" value="Release for Review"  />
			{% else %}
				<span class="text-success">This has been readied for review. It is a {{ topic.topic_object.presentationlength }} minute presentation.</span>
				<input type="submit" value="Change" class="btn btn-primary"  /><br>
				<small>This was set at {{topic.topic_object.datesetforreview}}</small>
			{% endif %}
			</form>
		</div><!-- #release_interface -->
		{% endif %}
		{% endif %}
	</div>
	{{ topic.comment_form|safe }}
	{% for comment in topic.comments %}
		{{ comment.html|safe }}
	{% endfor %}

{% endblock %}
{% block scripts %}
<script>


	$(function(){

		{% if commentnotification %}
			toastr.success('Your comment has been added.');
		{% endif %}

		{% if releasednotification %}
			toastr.success('You have approved the topic.');
		{% endif %}

		{% if updatednotification %}
			toastr.success('You have updated your topic.');
		{% endif %}

		{% if deleteddocumentdnotification %}
			toastr.error('You have deleted one of your documents.');
		{% endif %}

		{% if addednotification %}
			toastr.success('You have added a document.');
		{% endif %}

		if(window.location.hash == '#added'){
			toastr.success('You added \'{{ topic.topic_object.name }}\'.');
		}

		$('.change_document .document_button').hide();

		$('.document_button').css({'cursor':'pointer'}).click(function(){

				var html = "";
			
				//Gets the parent tr with the publicid
				var documentid = $(this).parent().parent().attr('publicid');
			
				if($(this).hasClass('icon-upload')){
					modal_id = '#update_document_'+documentid
				}

			if($(this).hasClass('icon-trash')){
				modal_id = '#deleted_document_'+documentid
			}

			if($(this).hasClass('icon-plus-sign')){
				modal_id = '#add_document'
			}
		
			$(modal_id).modal();

		});

		$('.document_item').hover(function(){

			var publicid = $(this).attr('publicid');

			$('i[publicid="'+publicid+'"]').each(function(){

				$(this).tooltip({track:true, tooltipClass: "yellow-tooltip"});

				$(this).show();
				if($(this).hasClass('icon-upload')){
					message = 'Upload a revision.';
				}

				if($(this).hasClass('icon-trash')){
					message = 'Delete this document.';
				}

			});

		},function(){
			if($(this).hasClass('change_document')){
				var publicid = $(this).attr('publicid');
				$('i[publicid="'+publicid+'"]').each(function(){
					$(this).hide();
				});
			}
		});

		$('.download_link').tooltip({track:true, tooltipClass: "yellow-tooltip"});

	});
</script>
{% endblock %}